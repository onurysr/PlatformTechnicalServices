@model PaymentViewModel
@{
    ViewBag.Title = $"Ödeme Sayfası";
}


<div class="content">
    <div class="container">
        <div class="row">
            <div class="col-md-12 col-lg-12 contents">
                <div class="row justify-content-center">
                    <div class="col-md-12">
                        <div class="mb-4">
                            <h1 style="text-align:center">@ViewBag.Title</h1>
                        </div>
                        <form asp-controller="Payment" asp-action="Index" method="post">
                            <input asp-for="Installment" type="hidden" id="hdInstallment" value="1" />
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="form-group first" >
                                                <label asp-for="CardModel.CardHolderName"></label>
                                                <input asp-for="CardModel.CardHolderName" class="form-control" />
                                                <span asp-validation-for="CardModel.CardHolderName" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-lg-12">
                                            <div class="form-group first">
                                                <label asp-for="CardModel.CardNumber"></label>
                                                <input asp-for="CardModel.CardNumber" class="form-control" id="txtCardNumber" />
                                                <span asp-validation-for="CardModel.CardNumber" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="form-group first">
                                                <label asp-for="CardModel.ExpireMonth"></label>
                                                <input asp-for="CardModel.ExpireMonth" class="form-control" />
                                                <span asp-validation-for="CardModel.ExpireMonth" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="form-group first">
                                                <label asp-for="CardModel.ExpireYear"></label>
                                                <input asp-for="CardModel.ExpireYear" class="form-control" />
                                                <span asp-validation-for="CardModel.ExpireYear" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="form-group first">
                                                <label asp-for="CardModel.Cvc"></label>
                                                <input asp-for="CardModel.Cvc" class="form-control" />
                                                <span asp-validation-for="CardModel.Cvc" class="text-danger"></span>
                                            </div>
                                        </div>

                                    </div>
                                    
                                </div>

                                <div class="col-lg-6">
                                    <div class="order-details mt-md-gap-50">
                                        <h3 class="title">Ödeme Seçenekleri</h3>
                                        <div class="order-table table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th></th>
                                                        <th>Taksit Sayısı</th>
                                                        <th>Ödenecek Tutar</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="table-installment">
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="payment-box mt-30">
                                            <input type="submit" class="main-btn btn-info" value="Ödeme Yap" />
                                        </div>
                                    </div>
                                </div>
                            </div>



                        </form>
                    </div>
                </div>

            </div>

        </div>
    </div>
</div>


@section Scripts{
<script>
    $(document).ready(function(){
        console.log("Jquery OK");
        //$("#txtCardNumber").keyup(function(){
        //    var binNumber = $(this).val();
        //    if(binNumber.length===6){
        //        console.log("Taksit bilgisi istenecek");
        //    }
        //});
        $("#txtCardNumber").blur(function(){
            var binNumber = $(this).val();
            console.log(binNumber);
            if(binNumber.length>=6 && binNumber.length<=16){
                console.log("Taksit bilgisi istenecek: " + binNumber);
                $.ajax({
                    url:'@Url.Action("CheckInstalment","Payment")',
                    method: 'POST',
                    data:{
                        binNumber: binNumber,
                        price: 1000
                    },
                    success:function(response){
                        fillInstallments(response.installmentPrices);
                    },
                    error: function(error){
                        console.log(error);
                    }
                });
            }
        });
        function fillInstallments(installmentPrices){
            $("#table-installment").empty();
            for(var i =0;i<installmentPrices.length;i++){
                var data = installmentPrices[i];
                console.log(data);

                var tr = document.createElement("tr");
                var td1 = document.createElement("td");
                var td2 = document.createElement("td");
                var td3 = document.createElement("td");
                var radio = document.createElement("input");
                var label = document.createElement("label");

                $(radio)
                .attr("type","radio")
                .attr("name","install-radio")
                .attr("data",data.installmentNumber)
                .attr("id","rd"+i)
                .appendTo(td1);
                $(label)
                .attr("for","rd" +i)
                .html(data.installmentNumber)
                .appendTo(td1)

                $(radio).on('change',function(){
                    $("#hdInstallment").val($(this).attr("data"));
                });

                if(i==0){
                    $(radio).prop('checked',true);
                }

                $(td2).html(data.price);
                $(td3).html(data.totalPrice);

                $(tr).append(td1).append(td2).append(td3).appendTo($("#table-installment"));

            }
        }
    });
</script>
}